#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Home Assistant Add-on: Vector
# Generates the Vector configuration from addon options
# ==============================================================================

set -e

declare victorialogs_endpoint
declare hostname
declare instance
declare collect_journal
declare collect_docker
declare stream_fields
declare custom_config_path

# Read configuration
victorialogs_endpoint=$(bashio::config 'victorialogs_endpoint')
hostname=$(bashio::config 'hostname')
instance=$(bashio::config 'instance')
collect_journal=$(bashio::config 'collect_journal')
collect_docker=$(bashio::config 'collect_docker')

# Validate required configuration
if bashio::var.is_empty "${victorialogs_endpoint}"; then
    bashio::log.fatal "VictoriaLogs endpoint is required!"
    bashio::exit.nok
fi

# Use hostname from system if not specified
if bashio::var.is_empty "${hostname}"; then
    hostname=$(hostname)
fi

# Build stream fields list (read directly from options.json for proper JSON parsing)
stream_fields=$(jq -r '.stream_fields | join(",")' /data/options.json)

# Check for custom config
custom_config_path=$(bashio::config 'custom_config_path')
if bashio::var.has_value "${custom_config_path}" && [[ -f "${custom_config_path}" ]]; then
    bashio::log.info "Using custom configuration from: ${custom_config_path}"
    cp "${custom_config_path}" /etc/vector/vector.yaml
    exit 0
fi

bashio::log.info "Generating Vector configuration..."
bashio::log.info "VictoriaLogs endpoint: ${victorialogs_endpoint}"
bashio::log.info "Hostname: ${hostname}"
bashio::log.info "Instance: ${instance}"
bashio::log.info "Collect journal: ${collect_journal}"
bashio::log.info "Collect docker: ${collect_docker}"

# Create config directory
mkdir -p /etc/vector

# Start generating the configuration
cat > /etc/vector/vector.yaml << 'VECTORCONFIG'
# Vector Configuration - Auto-generated by Home Assistant Add-on
# Do not edit directly; modify addon options instead

data_dir: /share/vector

# API for healthcheck and monitoring
api:
  enabled: true
  address: 0.0.0.0:8686

VECTORCONFIG

# Add sources section
echo "sources:" >> /etc/vector/vector.yaml

# Track which sources are enabled for transform inputs
declare -a enabled_sources=()

# Add journald source if enabled
if bashio::var.true "${collect_journal}"; then
    bashio::log.info "Enabling journald source..."
    enabled_sources+=("journald")

    cat >> /etc/vector/vector.yaml << 'JOURNALDSOURCE'
  journald:
    type: journald
    current_boot_only: false
JOURNALDSOURCE

    # Add include_units if specified
    units_count=$(jq -r '.journal_include_units | length' /data/options.json)
    if [[ "${units_count}" -gt 0 ]]; then
        echo "    include_units:" >> /etc/vector/vector.yaml
        jq -r '.journal_include_units[] | "      - " + .' /data/options.json >> /etc/vector/vector.yaml
    fi

    # Add exclude_units if specified
    units_count=$(jq -r '.journal_exclude_units | length' /data/options.json)
    if [[ "${units_count}" -gt 0 ]]; then
        echo "    exclude_units:" >> /etc/vector/vector.yaml
        jq -r '.journal_exclude_units[] | "      - " + .' /data/options.json >> /etc/vector/vector.yaml
    fi

    echo "" >> /etc/vector/vector.yaml
fi

# Add docker_logs source if enabled
if bashio::var.true "${collect_docker}"; then
    bashio::log.info "Enabling docker_logs source..."
    enabled_sources+=("docker_logs")

    cat >> /etc/vector/vector.yaml << 'DOCKERSOURCE'
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock
DOCKERSOURCE

    # Add include_containers if specified
    containers_count=$(jq -r '.docker_include_containers | length' /data/options.json)
    if [[ "${containers_count}" -gt 0 ]]; then
        echo "    include_containers:" >> /etc/vector/vector.yaml
        jq -r '.docker_include_containers[] | "      - " + .' /data/options.json >> /etc/vector/vector.yaml
    fi

    # Add exclude_containers if specified
    containers_count=$(jq -r '.docker_exclude_containers | length' /data/options.json)
    if [[ "${containers_count}" -gt 0 ]]; then
        echo "    exclude_containers:" >> /etc/vector/vector.yaml
        jq -r '.docker_exclude_containers[] | "      - " + .' /data/options.json >> /etc/vector/vector.yaml
    fi

    echo "" >> /etc/vector/vector.yaml
fi

# Check if any sources are enabled
if [[ ${#enabled_sources[@]} -eq 0 ]]; then
    bashio::log.fatal "At least one log source must be enabled!"
    bashio::exit.nok
fi

# Build inputs list for transforms
inputs_yaml=""
for source in "${enabled_sources[@]}"; do
    inputs_yaml="${inputs_yaml}      - ${source}\n"
done

# Add transforms section
cat >> /etc/vector/vector.yaml << TRANSFORMS
transforms:
  enrich_logs:
    type: remap
    inputs:
$(printf '%b' "${inputs_yaml}")    source: |
      # Add standard labels
      .host = "${hostname}"
      .instance = "${instance}"
      .source_type = .source_type ?? "unknown"

      # For journald logs - extract useful fields
      if exists(._SYSTEMD_UNIT) {
        .unit = replace(string!(._SYSTEMD_UNIT), r'\.service$', "")
        .container_name = .unit
      }

      # Extract container name from journald if available
      if exists(.CONTAINER_NAME) {
        .container_name = del(.CONTAINER_NAME)
      }

      # For docker logs
      if exists(.container_name) {
        .unit = .container_name
      }

      # Extract priority/level
      if exists(.PRIORITY) {
        priority = to_int(.PRIORITY) ?? 6
        .level = if priority == 0 { "emergency" }
                 else if priority == 1 { "alert" }
                 else if priority == 2 { "critical" }
                 else if priority == 3 { "error" }
                 else if priority == 4 { "warning" }
                 else if priority == 5 { "notice" }
                 else if priority == 6 { "info" }
                 else { "debug" }
      }

      # Ensure message field exists
      if !exists(.message) {
        if exists(.MESSAGE) {
          .message = del(.MESSAGE)
        } else {
          .message = encode_json(.)
        }
      }

      # Add timestamp if missing
      if !exists(.timestamp) {
        .timestamp = now()
      }
TRANSFORMS

# Add extra labels if specified
extra_labels_count=$(jq -r '.extra_labels | keys | length' /data/options.json)
if [[ "${extra_labels_count}" -gt 0 ]]; then
    bashio::log.info "Adding extra labels..."
    echo "" >> /etc/vector/vector.yaml
    echo "      # Extra custom labels" >> /etc/vector/vector.yaml
    jq -r '.extra_labels | to_entries | .[] | "      ." + .key + " = \"" + .value + "\""' /data/options.json >> /etc/vector/vector.yaml
fi

# Add sinks section
cat >> /etc/vector/vector.yaml << SINKS

sinks:
  victorialogs:
    type: elasticsearch
    inputs:
      - enrich_logs
    endpoints:
      - "${victorialogs_endpoint}/insert/elasticsearch/"
    api_version: v8
    compression: gzip
    healthcheck:
      enabled: false
    query:
      _msg_field: message
      _time_field: timestamp
      _stream_fields: ${stream_fields}
SINKS

bashio::log.info "Vector configuration generated successfully"
bashio::log.info "Configuration saved to /etc/vector/vector.yaml"

# Validate the configuration
if vector validate --config /etc/vector/vector.yaml; then
    bashio::log.info "Configuration validation passed"
else
    bashio::log.error "Configuration validation failed!"
    bashio::log.error "Generated configuration:"
    cat /etc/vector/vector.yaml
    bashio::exit.nok
fi
